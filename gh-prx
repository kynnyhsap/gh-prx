#!/usr/bin/env node

import { spawnSync } from "node:child_process";
import { dirname, resolve } from "node:path";
import { fileURLToPath } from "node:url";
import { existsSync } from "node:fs";

const rootDir = dirname(fileURLToPath(import.meta.url));
const entryFile = resolve(rootDir, "dist/index.js");
const argv = process.argv.slice(2);

const nodeMajor = Number((process.versions.node || "0").split(".")[0]);
if (nodeMajor < 20) {
  process.stderr.write("error: Node.js 20+ is required (or run with Bun).\n");
  process.exit(1);
}

if (!existsSync(entryFile)) {
  process.stderr.write("error: build output is missing. Run `bun run build` first.\n");
  process.exit(1);
}

const hasBun = spawnSync("bun", ["--version"], { stdio: "ignore" }).status === 0;

const command = hasBun ? ["bun", entryFile, ...argv] : [process.execPath, entryFile, ...argv];

const proc = spawnSync(command[0], command.slice(1), {
  stdio: "inherit",
});

if (proc.error) {
  process.stderr.write(`error: failed to start runtime: ${proc.error.message}\n`);
  process.exit(1);
}

process.exit(proc.status ?? 1);
